---
- name: Ensure secrets directory exists on host
  ansible.builtin.file:
    path: "{{ netbox_install_dir }}/.secrets"
    state: directory
    mode: '0700'

- name: Check if secrets exist
  ansible.builtin.stat:
    path: "{{ netbox_install_dir }}/.secrets/{{ item }}"
  loop:
    - redis_mq_password
    - redis_cache_password
    - secret_key
    - api_token_pepper
  register: secret_files

- name: Generate Redis MQ password if missing
  ansible.builtin.command:
    cmd: sh -c "tr -dc 'A-Za-z0-9!@#$%^&*()_+=-' < /dev/urandom | head -c 32 > {{ netbox_install_dir }}/.secrets/redis_mq_password"
    creates: "{{ netbox_install_dir }}/.secrets/redis_mq_password"
  when: not secret_files.results[0].stat.exists

- name: Generate Redis cache password if missing
  ansible.builtin.command:
    cmd: sh -c "tr -dc 'A-Za-z0-9!@#$%^&*()_+=-' < /dev/urandom | head -c 32 > {{ netbox_install_dir }}/.secrets/redis_cache_password"
    creates: "{{ netbox_install_dir }}/.secrets/redis_cache_password"
  when: not secret_files.results[1].stat.exists

- name: Generate secret key if missing
  ansible.builtin.command:
    cmd: sh -c "tr -dc 'A-Za-z0-9' < /dev/urandom | head -c 64 > {{ netbox_install_dir }}/.secrets/secret_key"
    creates: "{{ netbox_install_dir }}/.secrets/secret_key"
  when: not secret_files.results[2].stat.exists

- name: Generate API token pepper if missing
  ansible.builtin.command:
    cmd: sh -c "tr -dc 'A-Za-z0-9' < /dev/urandom | head -c 64 > {{ netbox_install_dir }}/.secrets/api_token_pepper"
    creates: "{{ netbox_install_dir }}/.secrets/api_token_pepper"
  when: not secret_files.results[3].stat.exists

- name: Set file permissions on secrets
  ansible.builtin.file:
    path: "{{ netbox_install_dir }}/.secrets/{{ item }}"
    mode: '0600'
  loop:
    - redis_mq_password
    - redis_cache_password
    - secret_key
    - api_token_pepper

- name: Read secrets from host
  ansible.builtin.slurp:
    src: "{{ netbox_install_dir }}/.secrets/{{ item }}"
  loop:
    - redis_mq_password
    - redis_cache_password
    - secret_key
    - api_token_pepper
  register: secret_contents

- name: Set NetBox secret facts
  ansible.builtin.set_fact:
    netbox_redis_mq_password: "{{ secret_contents.results[0].content | b64decode | trim }}"
    netbox_redis_cache_password: "{{ secret_contents.results[1].content | b64decode | trim }}"
    netbox_secret_key: "{{ secret_contents.results[2].content | b64decode | trim }}"
    netbox_api_token_pepper_1: "{{ secret_contents.results[3].content | b64decode | trim }}"
